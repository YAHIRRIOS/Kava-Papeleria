<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/Direcciones.css">
    <link rel="stylesheet" href="/css/barra-navegacion.css">
    <title>Checkout</title>
</head>
<body>
    <%- include('template/barra-navegacion', { carrito }) %>

    <div class="container">
        <!-- Secci√≥n: Direcciones guardadas -->
        <div class="saved-addresses">
            <h3>Direcciones Guardadas</h3>
            <% if (direcciones && direcciones.length > 0) { %>
                <form action="/pago/pagoPaypal" method="POST">
                    <% direcciones.forEach((direccion, index) => { %>
                        <div class="address-card">
                            <div class="address-top-row">
                                <div class="radio-delete">
                                    <input type="radio" name="direccionSeleccionada" value="<%= direccion._id %>" <%= index === 0 ? 'checked' : '' %> />
                                    <button type="button" class="delete-btn" onclick="eliminarDireccion('<%= direccion._id %>')">üóëÔ∏è Eliminar</button>
                                </div>
                            </div>
                            <div class="address-details">
                                <p><strong>Calle:</strong> <%= direccion.calle %></p>
                                <p><strong>Ciudad:</strong> <%= direccion.ciudad %></p>
                                <p><strong>C√≥digo Postal:</strong> <%= direccion.codigoPostal %></p>
                                <p><strong>Pa√≠s:</strong> <%= direccion.pais %></p>
                            </div>
                        </div>
                    <% }) %>
                    <button class="proceed-btn" type="submit">Proceder al pago</button>
                </form>
            <% } else { %>
                <p>No tienes direcciones guardadas a√∫n.</p>
            <% } %>
        </div>

        <!-- Formulario para agregar nueva direcci√≥n -->
        <div class="shipping-address">
            <h3>Agregar nueva direcci√≥n</h3>
            <% if (direcciones && direcciones.length >= 3) { %>
                <p style="color: red;">Solo puedes guardar hasta 3 direcciones.</p>
            <% } else { %>
                <form action="/pago/agregarDireccion" method="POST" id="form-direccion">
                    <div class="form-group">
                        <label>Calle</label>
                        <input type="text" name="calle" required>
                        <span id="calleError" style="color: red; display: none;">La calle no debe contener caracteres especiales ni secuencias.</span>
                    </div>
                    <div class="form-group">
                        <label>Ciudad</label>
                        <input type="text" name="ciudad" required>
                        <span id="ciudadError" style="color: red; display: none;">La ciudad no debe contener caracteres especiales ni secuencias.</span>
                    </div>
                    <div class="form-group">
                        <label>C√≥digo Postal</label>
                        <input type="text" name="codigoPostal" required>
                    </div>
                    <div class="form-group">
                        <label>Pa√≠s</label>
                        <select name="pais" required>
                            <option value="">Seleccione un pa√≠s</option>
                            <option value="M√©xico">M√©xico</option>
                            <option value="Argentina">Argentina</option>
                            <option value="Espa√±a">Espa√±a</option>
                            <option value="Colombia">Colombia</option>
                            <option value="Chile">Chile</option>
                            <option value="Per√∫">Per√∫</option>
                            <option value="Estados Unidos">Estados Unidos</option>
                            <option value="Canad√°">Canad√°</option>
                        </select>
                    </div>
                    <button class="btn" type="submit">Guardar Direcci√≥n</button>
                </form>
            <% } %>
        </div>
    </div>

    <!-- Script de eliminaci√≥n y validaci√≥n -->
    <script>
        function eliminarDireccion(id) {
            fetch(`/pago/eliminarDireccion/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error al eliminar la direcci√≥n');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar la direcci√≥n');
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('form-direccion');
            if (form) {
                form.addEventListener('submit', function (e) {
                    const calle = form.calle.value.trim();
                    const ciudad = form.ciudad.value.trim();
                    const codigoPostal = form.codigoPostal.value.trim();
                    const pais = form.pais.value;

                    const errores = [];

                    // Validaci√≥n de la calle (no debe contener caracteres especiales ni secuencias como ..... o ------)
                    const regexCalle = /^[a-zA-Z0-9\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]+$/;
                    const secuenciasNoPermitidas = /[-\.]{3,}/; // No permite secuencias de guiones o puntos

                    if (!regexCalle.test(calle) || secuenciasNoPermitidas.test(calle)) {
                        errores.push('La calle no debe contener caracteres especiales ni secuencias.');
                        document.getElementById('calleError').style.display = 'block';
                    } else {
                        document.getElementById('calleError').style.display = 'none';
                    }

                    // Validaci√≥n de la ciudad (igual que la calle)
                    const regexCiudad = /^[a-zA-Z0-9\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]+$/;

                    if (!regexCiudad.test(ciudad) || secuenciasNoPermitidas.test(ciudad)) {
                        errores.push('La ciudad no debe contener caracteres especiales ni secuencias.');
                        document.getElementById('ciudadError').style.display = 'block';
                    } else {
                        document.getElementById('ciudadError').style.display = 'none';
                    }

                    // Validaci√≥n del c√≥digo postal (no se cambia)
                    if (!/^\d{5}$/.test(codigoPostal)) {
                        errores.push('El c√≥digo postal debe tener exactamente 5 d√≠gitos num√©ricos.');
                    }

                    // Validaci√≥n del pa√≠s
                    if (pais === "") {
                        errores.push('Debe seleccionar un pa√≠s v√°lido.');
                    }

                    if (errores.length > 0) {
                        e.preventDefault();
                        alert(errores.join('\n'));
                    }
                });
            }
        });
    </script>
</body>
</html>

