<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/Direcciones.css">
    <link rel="stylesheet" href="/css/barra-navegacion.css">
    <title>Checkout</title>
</head>
<body>
    <%- include('template/barra-navegacion', { carrito }) %>

    <div class="container">
        <!-- Secci√≥n: Direcciones guardadas -->
        <div class="saved-addresses">
            <h3>Direcciones Guardadas</h3>
            <% if (direcciones && direcciones.length > 0) { %>
                <form action="/pago/pagoPaypal" method="POST">
                    <% direcciones.forEach((direccion, index) => { %>
                        <div class="address-card">
                            <div class="address-top-row">
                                <div class="radio-delete">
                                    <input type="radio" name="direccionSeleccionada" value="<%= direccion._id %>" <%= index === 0 ? 'checked' : '' %> />
                                    <button type="button" class="delete-btn" onclick="eliminarDireccion('<%= direccion._id %>')">üóëÔ∏è Eliminar</button>
                                </div>
                            </div>
                            <div class="address-details">
                                <p><strong>Calle:</strong> <%= direccion.calle %></p>
                                <p><strong>Ciudad:</strong> <%= direccion.ciudad %></p>
                                <p><strong>C√≥digo Postal:</strong> <%= direccion.codigoPostal %></p>
                                <p><strong>Pa√≠s:</strong> <%= direccion.pais %></p>
                            </div>
                        </div>
                    <% }) %>
                    <button class="proceed-btn" type="submit">Proceder al pago</button>
                </form>
            <% } else { %>
                <p>No tienes direcciones guardadas a√∫n.</p>
            <% } %>
        </div>

        <!-- Formulario para agregar nueva direcci√≥n -->
        <div class="shipping-address">
            <h3>Agregar nueva direcci√≥n</h3>
            <% if (direcciones && direcciones.length >= 3) { %>
                <p style="color: red;">Solo puedes guardar hasta 3 direcciones.</p>
            <% } else { %>
                <form action="/pago/agregarDireccion" method="POST" id="form-direccion">
                    <div class="form-group">
                        <label>Calle</label>
                        <input type="text" name="calle" id="calle" maxlength="30" required>
                        <span id="calleError" style="color: red; display: none;">La calle debe tener al menos 3 caracteres v√°lidos, contener letras y no incluir s√≠mbolos repetidos.</span>
                    </div>
                    <div class="form-group">
                        <label>Ciudad</label>
                        <input type="text" name="ciudad" id="ciudad" maxlength="20" required>
                        <span id="ciudadError" style="color: red; display: none;">La ciudad debe tener al menos 3 caracteres v√°lidos, contener letras y no incluir s√≠mbolos repetidos.</span>
                    </div>
                    <div class="form-group">
                        <label>C√≥digo Postal</label>
                        <input type="text" name="codigoPostal" id="codigoPostal" required>
                        <span id="codigoPostalError" style="color: red; display: none;">El c√≥digo postal debe tener exactamente 5 d√≠gitos num√©ricos.</span>
                    </div>
                    <div class="form-group">
                        <label>Pa√≠s</label>
                        <select name="pais" required>
                            <option value="">Seleccione un pa√≠s</option>
                            <option value="M√©xico">M√©xico</option>
                            <option value="Argentina">Argentina</option>
                            <option value="Espa√±a">Espa√±a</option>
                            <option value="Colombia">Colombia</option>
                            <option value="Chile">Chile</option>
                            <option value="Per√∫">Per√∫</option>
                            <option value="Estados Unidos">Estados Unidos</option>
                            <option value="Canad√°">Canad√°</option>
                        </select>
                    </div>
                    <button class="btn" type="submit">Guardar Direcci√≥n</button>
                </form>
            <% } %>
        </div>
    </div>

    <!-- Script de validaciones en tiempo real y eliminaci√≥n -->
    <script>
        function eliminarDireccion(id) {
            fetch(`/pago/eliminarDireccion/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error al eliminar la direcci√≥n');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar la direcci√≥n');
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('form-direccion');
            const calleInput = document.getElementById('calle');
            const ciudadInput = document.getElementById('ciudad');
            const codigoPostalInput = document.getElementById('codigoPostal');

            const regexValido = /^[a-zA-Z0-9\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]+$/;
            const contieneLetra = /[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/;
            const secuenciasInvalidas = /[-\.]{3,}/;

            function validarCampoTexto(input, errorId) {
                const valor = input.value.trim();
                const esValido = valor.length >= 3 &&
                                 regexValido.test(valor) &&
                                 contieneLetra.test(valor) &&
                                 !secuenciasInvalidas.test(valor);
                document.getElementById(errorId).style.display = esValido ? 'none' : 'block';
                return esValido;
            }

            function validarCodigoPostal() {
                codigoPostalInput.value = codigoPostalInput.value.replace(/\D/g, '').slice(0, 5);
                const esValido = /^\d{5}$/.test(codigoPostalInput.value);
                document.getElementById('codigoPostalError').style.display = esValido ? 'none' : 'block';
                return esValido;
            }

            // Validaciones en tiempo real
            calleInput.addEventListener('input', () => validarCampoTexto(calleInput, 'calleError'));
            ciudadInput.addEventListener('input', () => validarCampoTexto(ciudadInput, 'ciudadError'));
            codigoPostalInput.addEventListener('input', validarCodigoPostal);

            // Bloquear pegar en c√≥digo postal
            codigoPostalInput.addEventListener('paste', function (e) {
                e.preventDefault();
            });

            // Validaci√≥n final en submit
            if (form) {
                form.addEventListener('submit', function (e) {
                    const calleValida = validarCampoTexto(calleInput, 'calleError');
                    const ciudadValida = validarCampoTexto(ciudadInput, 'ciudadError');
                    const codigoPostalValido = validarCodigoPostal();
                    const paisSeleccionado = form.pais.value !== "";

                    const errores = [];
                    if (!calleValida) errores.push("Calle inv√°lida.");
                    if (!ciudadValida) errores.push("Ciudad inv√°lida.");
                    if (!codigoPostalValido) errores.push("C√≥digo postal inv√°lido.");
                    if (!paisSeleccionado) errores.push("Seleccione un pa√≠s.");

                    if (errores.length > 0) {
                        e.preventDefault();
                        alert(errores.join('\n'));
                    }
                });
            }
        });
    </script>
</body>
</html>
